Author: Steve Langasek <steve.langasek@canonical.com>
Description: support initramfsless boot
 Don't fail if --attach-to-session is passed and /dev/pts isn't mounted
 yet, as this breaks booting without an initramfs.
Bug-Ubuntu: https://bugs.launchpad.net/bugs/981314
Last-Update: 2012-04-15

Index: trunk/src/main.c
===================================================================
--- trunk.orig/src/main.c
+++ trunk/src/main.c
@@ -1701,6 +1701,7 @@
      session = ply_terminal_session_new (NULL);
 
      ply_terminal_session_attach_to_event_loop (session, state->loop);
+     state->session = session;
    }
  else
    {
@@ -1715,12 +1716,6 @@
                                  (should_be_redirected? on_session_hangup: NULL),
                                  -1, state))
     {
-      ply_save_errno ();
-      ply_terminal_session_free (session);
-      ply_buffer_free (state->boot_buffer);
-      state->boot_buffer = NULL;
-      ply_restore_errno ();
-
       state->is_redirected = false;
       state->is_attached = false;
       return false;
@@ -1728,7 +1723,6 @@
 
   state->is_redirected = should_be_redirected;
   state->is_attached = true;
-  state->session = session;
 
   return true;
 }
@@ -2408,9 +2402,6 @@
       if (!attach_to_running_session (&state))
         {
           ply_trace ("could not redirect console session: %m");
-          if (! no_daemon)
-            ply_detach_daemon (daemon_handle, EX_UNAVAILABLE);
-          return EX_UNAVAILABLE;
         }
     }
 
